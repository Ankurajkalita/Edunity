{% extends "base.html" %}

{% block title %}AI Mentor{% endblock %}

{% block extra_css %}
<style>
    .chat-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .chat-container::-webkit-scrollbar-track {
        background: var(--secondary-bg);
    }
    
    .chat-container::-webkit-scrollbar-thumb {
        background: var(--accent-color);
        border-radius: 4px;
    }

    .typing-indicator {
        display: inline-block;
        padding-left: 5px;
    }

    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: var(--text-color);
        border-radius: 50%;
        margin: 0 2px;
        opacity: 0.4;
        animation: typing 1s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 100% { opacity: 0.4; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-page">
    <!-- Sidebar -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h3>Chat History</h3>
            <button id="newChatBtn" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> New Chat
            </button>
        </div>
        <div class="chat-sessions">
            <!-- Chat sessions will be added here dynamically -->
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-main">
        <div class="chat-container">
            <div id="messageArea" class="message-area">
                <div class="welcome-message">
                    <h2>Welcome to AI Career Mentor</h2>
                    <p class="lead">I'm here to help you with:</p>
                    <ul>
                        <li>Career planning and guidance</li>
                        <li>Skill development recommendations</li>
                        <li>Study plans and resources</li>
                        <li>Industry insights and trends</li>
                    </ul>
                    <p>How can I assist you today?</p>
                </div>
                {% for message in messages %}
                <div class="chat-message {% if message.role == 'user' %}user-message{% else %}bot-message{% endif %} animate-fade-in">
                    {{ message.content | safe }}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="chat-input-area">
            <form id="chatForm" class="chat-form">
                <div class="input-group">
                    <input type="text" id="userInput" class="form-control" placeholder="Type your message here..." required>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </form>
            <div id="typingIndicator" class="typing-indicator d-none">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');
    const messageArea = document.getElementById('messageArea');
    const typingIndicator = document.getElementById('typingIndicator');
    const chatSessions = document.querySelector('.chat-sessions');
    const newChatBtn = document.getElementById('newChatBtn');
    
    let currentChatId = Date.now().toString();
    
    // Function to create a new chat session
    function createNewChat() {
        currentChatId = Date.now().toString();
        const sessionEl = document.createElement('div');
        sessionEl.className = 'chat-session active';
        sessionEl.dataset.chatId = currentChatId;
        sessionEl.innerHTML = `
            <i class="fas fa-comments"></i>
            <span>New Conversation</span>
            <div class="session-actions">
                <button class="btn btn-sm btn-link rename-chat">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
        `;
        chatSessions.insertBefore(sessionEl, chatSessions.firstChild);
        messageArea.innerHTML = ''; // Clear messages
        return sessionEl;
    }
    
    // Initialize with first chat
    createNewChat();
    
    // New chat button handler
    newChatBtn.addEventListener('click', () => {
        document.querySelectorAll('.chat-session').forEach(s => s.classList.remove('active'));
        createNewChat();
    });
    
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;
        
        // Add user message
        const userMessageEl = document.createElement('div');
        userMessageEl.className = 'chat-message user-message animate-fade-in';
        userMessageEl.textContent = message;
        messageArea.appendChild(userMessageEl);
        
        // Clear input and scroll to bottom
        userInput.value = '';
        messageArea.scrollTop = messageArea.scrollHeight;
        
        // Show typing indicator
        typingIndicator.classList.remove('d-none');
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            });
            
            const data = await response.json();
            
            // Hide typing indicator
            typingIndicator.classList.add('d-none');
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Add bot response
            const botMessageEl = document.createElement('div');
            botMessageEl.className = 'chat-message bot-message animate-fade-in';
            botMessageEl.innerHTML = data.response;
            messageArea.appendChild(botMessageEl);
            
            // Update chat session title with first few words of user message
            const activeSession = document.querySelector('.chat-session.active span');
            if (activeSession) {
                activeSession.textContent = message.slice(0, 30) + (message.length > 30 ? '...' : '');
            }
        } catch (error) {
            // Hide typing indicator
            typingIndicator.classList.add('d-none');
            
            // Show error message
            const errorEl = document.createElement('div');
            errorEl.className = 'chat-message error-message animate-fade-in';
            errorEl.textContent = 'Error: ' + error.message;
            messageArea.appendChild(errorEl);
        }
        
        // Scroll to bottom
        messageArea.scrollTop = messageArea.scrollHeight;
    });
});
</script>
{% endblock %} 